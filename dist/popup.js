"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _classCallCheck(t,i){if(!(t instanceof i))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,i){for(var e=0;e<i.length;e++){var o=i[e];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(t,o.key,o)}}function _createClass(t,i,e){return i&&_defineProperties(t.prototype,i),e&&_defineProperties(t,e),t}require("../scss/common-popup");var $=require("jquery"),POINTER_HEIGHT=7,$popup_arr={},popup_arr={},$window=$(window),api=function(){function h(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},i=1<arguments.length?arguments[1]:void 0;if(_classCallCheck(this,h),!($(t.trigger).length||t.trigger instanceof $))return null;for(var e in popup_arr)if(popup_arr[e].trigger===t.trigger.trim())return null;for(var o in this.constructor._default.call(this),t)"width"!==o&&"height"!==o||(this["_"+o]=t[o]),this[o]=t[o];this.constructor._getTriggerOffset.call(this);var r=this.version=+new Date,s=this.Popup='<div class="common_popup'.concat(r," common_popup v_hide ").concat(this.autoClose?"":"autoClose",'"></div>'),n=this.$Popup=$(s);$popup_arr[r]=this.$Popup,popup_arr[r]=this,n.html('<div class="_common-popup _common-popup'.concat(this.version,'">\n        ').concat(this.pointerHide?"":'<span class="pointer"></span>','\n        <div class="_common-popup-content"></div>\n      </div>'));this.$PopupContent=n.find("._common-popup-content");this.constructor._setPopupContent.call(this,this.content),$("body").append(n);this.$pointer=n.find(".pointer");if(this.constructor._setTriggerPosition.call(this),this.constructor._setPointerPosition.call(this),this.constructor._setPopupStyle.call(this),this.constructor.otherBind.call(this),this.constructor.eventTrigger.call(this),i&&"function"==typeof i){try{i.apply(this,arguments)}catch(t){console.log("callback error")}return this}return this.constructor._setPointerStyle.call(this),this}return _createClass(h,[{key:"show",value:function(t){var i=this;if(this.showBeforeCb&&this.showBeforeCb(),!this.content)return this;for(var e in this.autoInitContent&&this.constructor._setPopupContent.call(this,t),this.constructor._setTriggerPosition.call(this,!0),popup_arr)popup_arr[e].$Popup.hasClass("autoClose")||popup_arr[e].hide();return this.$trigger.attr("active","true").data("active","true"),setTimeout(function(){i.$Popup.removeClass("v_hide")},100),this.showAfterCb&&this.showAfterCb(),this}},{key:"showAim",value:function(t){return t.show(),this}},{key:"showAfter",value:function(t){return this.showAfterCb=t,this}},{key:"showBefore",value:function(t){return this.showBeforeCb=t,this}},{key:"hideAfter",value:function(t){return this.hideAfterCb=t,this}},{key:"hide",value:function(){return this.$Popup.addClass("v_hide"),this.$trigger.removeAttr("active").data("active",""),this.hideAfterCb&&this.hideAfterCb(),this}},{key:"justShow",value:function(t){for(var i in this.autoInitContent&&this.constructor._setPopupContent.call(this,t),this.constructor._setTriggerPosition.call(this,!0),$popup_arr){if($popup_arr[i].hasClass("autoClose"))break;$popup_arr[i].addClass("v_hide")}return this.$Popup.removeClass("v_hide"),this.showAfter&&this.showAfter(),this}},{key:"justHide",value:function(){this.$Popup.addClass("v_hide")}},{key:"hideAim",value:function(t){return t.hide(),this}}],[{key:"_default",value:function(){this.trigger="",this.triggerType="",this.direction="bottom",this.position=[0,0],this.pointer=[0,0],this.width=220,this.height="auto",this.fixed=!1,this.style={},this.content="",this.activeTrigger="",this.pointerHide=!1,this.autoClose=!0,this.autoInitContent=!0,this.debug=!1,this.pointerStyle=!1}},{key:"_getTriggerOffset",value:function(){if(this._trigger=this.trigger,this.$trigger=this.trigger instanceof $?this.trigger:$(this.trigger),!this.$trigger.length)throw new Error("【".concat(this._trigger,"】is undefined, can`t find this jquery elem"));this.activeTrigger&&(this.$trigger=this.activeTrigger);var t=this.$trigger.offset().top,i=this.$trigger.offset().left,e=this.$trigger.outerHeight(),o=this.$trigger.outerWidth();this.trigger_info={top:this.fixed?+t-$window.scrollTop():+t,left:+i,height:+e,width:+o},this.debug&&console.log("该实例目标info",this.trigger_info)}},{key:"_setTriggerPosition",value:function(t){t&&this.constructor._getTriggerOffset.call(this);var i={},e=this.$Popup.find("._common-popup".concat(this.version)),o=e.outerWidth(),r=e.outerHeight();this.debug&&console.log("该实例弹窗自身的宽、高",o,r),this.trigger_position={top:[this.trigger_info.left,this.trigger_info.top-r-POINTER_HEIGHT],left:[this.trigger_info.left-o-POINTER_HEIGHT,this.trigger_info.top],right:[this.trigger_info.left+this.trigger_info.width+POINTER_HEIGHT,this.trigger_info.top],bottom:[this.trigger_info.left,this.trigger_info.top+this.trigger_info.height+POINTER_HEIGHT]},this.fixed&&(i={position:"fixed"}),$.extend(i,{left:this.trigger_position[this.direction][0]+this.position[0],top:this.trigger_position[this.direction][1]+this.position[1]}),this.$Popup.find("._common-popup".concat(this.version)).css(i)}},{key:"_setPointerPosition",value:function(){var t=this.pointer[0],i=this.pointer[1];switch(this.direction){case"bottom":var e=this.constructor._getUnit.call(this,t),o=this.constructor._getNum.call(this,t);this.$pointer.css({left:"%"===e?o+e:10+o+e,top:"-5px"});break;case"top":var r=this.constructor._getUnit.call(this,t),s=this.constructor._getNum.call(this,t);this.$pointer.css({left:"%"===r?s+r:10+s+r,bottom:"-5px"});break;case"right":var n=this.constructor._getUnit.call(this,i),h=this.constructor._getNum.call(this,i);this.$pointer.css({left:"-5px",top:"%"===n?h+n:10+h+n});break;case"left":var c=this.constructor._getUnit.call(this,i),u=this.constructor._getNum.call(this,i);this.$pointer.css({right:"-5px",top:"%"===c?u+c:10+u+c})}this.$pointer.addClass(this.direction)}},{key:"_setPointerStyle",value:function(){try{"object"===_typeof(this.pointerStyle)&&this.$pointer.css({background:"red"})}catch(t){console.log("pointer style parameters passed in the wrong format")}}},{key:"_setPopupStyle",value:function(){var t={width:this.constructor._getNum.call(this,this._width)+this.constructor._getUnit.call(this,this._width),height:this.constructor._getNum.call(this,this._height)+this.constructor._getUnit.call(this,this._height)};$.extend(t,this.style),this.$Popup.find("._common-popup".concat(this.version)).css(t),+this.$Popup.find("._common-popup".concat(this.version)).css("width").replace(/[^0-9]/gi,"")+this.$trigger.offset().left+this.position[0]>$window.width()&&(t.width="auto",this.$Popup.find("._common-popup".concat(this.version)).css(t));var i={background:t.background?t.background:"#FFFFFF"};this.$Popup.find("._common-popup".concat(this.version," .pointer")).css(i)}},{key:"_getUnit",value:function(t){return-1<(t+"").indexOf("%")?"%":"px"}},{key:"_getNum",value:function(t){return Number.parseFloat(t)}},{key:"_setPopupContent",value:function(t){var i=t||this.content;this.$PopupContent.html(i)}},{key:"otherBind",value:function(){var i=this;$(document).off("click.popup_mark"),$(document).on("click.popup_mark",function(t){if(!$(t.target).parents(".common_popup").length)for(var i in popup_arr)popup_arr[i].$Popup.hasClass("v_hide")||popup_arr[i].hide()}),$window.resize(function(){for(var t in $popup_arr)$popup_arr[t].hasClass("v_hide")||i.constructor._setTriggerPosition.call(i,!0)})}},{key:"eventTrigger",value:function(){var t=this;t.triggerType.trim()&&("focus"===t.triggerType&&(t.triggerType="click"),"hover"===t.triggerType?$(document).on("mouseenter",t._trigger,function(){t.activeTrigger=$(this),clearTimeout(t.timeout),t.showAim(t)}).on("mouseleave",t._trigger,function(){t.activeTrigger=$(this),t.constructor._timeout.call(t,t)}).on("mouseenter","._common-popup".concat(this.version),function(){clearTimeout(t.timeout)}).on("mouseleave","._common-popup".concat(this.version),function(){t.hideAim(t)}):$(document).on(t.triggerType,t._trigger,function(){$(this).data("active")?t.hide():(t.activeTrigger=$(this),t.showAim(t))}))}},{key:"_timeout",value:function(t){var i=this;this.timeout=setTimeout(function(){i.hideAim(t)},160)}}]),h}();module.exports=api;